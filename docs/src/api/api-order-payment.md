# 注文処理API定義書

### 📜 概要

-   **機能:** カートに入っている商品を購買処理し、ユーザーの仮想クレジットを差し引き、購買履歴を記録します。
-   **呼び出し時点:** カートページ(`/cart`)でユーザーが「注文する」ボタンをクリックしたときに呼び出されます。
-   **主要ロジックファイル:** `src/pages/CartPage.jsx` (`handlePurchase` 関数)、`src/contexts/CreditContext.jsx` (`deductCredit`、`addPurchase` 関数)

---

### 📊 API 主要情報

*   **API 名称:** 注文処理 (クライアント内部ロジック)
*   **対象ストレージ:** React Context (`CreditContext`、`CartContext`)、`localStorage` (購買履歴保存)
*   **処理概要:** カートの合計金額と保有クレジットを比較して購買可能かどうかを判断し、購買成功時にクレジット差し引き、購買履歴追加、カートを空にするロジックを実行します。

---

### ➡️ リクエスト (Request)

#### クライアント内部関数呼び出し (`handlePurchase`)

*   **説明:** 現在カートに入っている商品リストと合計金額に基づいて購買を試みます。

| フィールド名   | タイプ     | 説明       |     例値          |
| --------- | -------- | --------------- |---------------- |
| `cartItems` | `Array<Object>` | 現在カートに入っている商品オブジェクトの配列      | `[{ id: 1, name: '商品A', price: 1000, quantity: 1 }]` |
| `totalAmount`| `number` | `cartItems`の合計決済金額               | `1000`                      |

---

### ⬅️ レスポンス (Response)

#### ✅ 成功レスポンス (クライアント内部処理)

*   **処理結果:**
    *   `CreditContext`から`totalAmount`分クレジットを差し引き。
    *   `CreditContext`を通じて購買した`cartItems`と`totalAmount`が購買履歴に追加 (内部的に`localStorage`に保存)。
    *   `CartContext`からカートを空にする。
*   **ユーザーフィードバック:** 「ご注文が完了しました、ありがとうございます！ 🎉」通知表示。

#### ❌ エラーレスポンス (クライアント内部処理)

| エラータイプ         | ユーザーフィードバックメッセージ             | 説明                                     |
| ----------------- | -------------------------------- | ---------------------------------------- |
| `ログインが必要です`     | `ログインが必要です。`           | 購買試行時にユーザーがログインしていません。 |
| `クレジット不足`     | `❌ クレジットが不足しているため、決済できません。` | 保有クレジットが合計決済金額より少ないです。 |